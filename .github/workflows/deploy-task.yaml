name: Deploy ECS task definition

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual trigger"
        required: false
        type: string
env:
  AWS_REGION: "eu-central-1"

permissions:
  id-token: write
  contents: read

jobs:
    discover:
      runs-on: ubuntu-latest
      outputs:
        matrix: ${{ steps.set-matrix.outputs.matrix }}
      steps:
        - uses: actions/checkout@v5
          with:
            ref: main

        - id: set-matrix
          shell: bash
          run: |
            set -euo pipefail

            # Find direct subdirectories under models/
            mapfile -t dirs < <(find models -mindepth 1 -maxdepth 1 -type d -print | sort)

            if [ ${#dirs[@]} -eq 0 ]; then
              echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
              exit 0
            fi

            json='{"include":['
            first=1

            for d in "${dirs[@]}"; do
              name="$(basename "$d")"
              dockerfile="$d/Dockerfile"
              pyproject="$d/pyproject.toml"
              python_version_file="$d/.python-version"

              # Skip folders without necessary files
              if [ ! -f "$dockerfile" ]; then
                echo "Skipping $d (no Dockerfile)"
                continue
              fi
              if [ ! -f "$pyproject" ]; then
                echo "Skipping $d (no pyproject.toml)"
                continue
              fi
              if [ ! -f "$python_version_file" ]; then
                echo "Skipping $d (no .python-version)"
                continue
              fi

              # Extract version from pyproject.toml (Poetry-style)
              version="$(grep -E '^[[:space:]]*version[[:space:]]*=' "$pyproject" | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')"

              if [ -z "$version" ]; then
                echo "Skipping $d (could not parse version in pyproject.toml)"
                continue
              fi

              # Read the Python version (first line)
              python_version="$(head -n 1 "$python_version_file" | tr -d '[:space:]')"

              if [ -z "$python_version" ]; then
                echo "Skipping $d (empty .python-version)"
                continue
              fi

              # Append to matrix JSON
              [ $first -eq 0 ] && json+=',' || first=0
              json+="{\"name\":\"$name\",\"context\":\"$d\",\"dockerfile\":\"$dockerfile\",\"version\":\"$version\",\"python_version\":\"$python_version\"}"
            done

            json+=']}'
            echo "matrix=$json" >> "$GITHUB_OUTPUT"
            echo "$json"

    deploy-task:
      needs: discover
      name: 'Deploy Task manifest file'
      if: ${{ fromJSON(needs.discover.outputs.matrix).include[0] != null }}
      runs-on: ubuntu-latest
      strategy:
        matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
        fail-fast: false

      steps:  
        - name: Checkout Codebase
          uses: actions/checkout@v5
          with:
            ref: main

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v5
          with:
            role-to-assume: ${{ secrets.ROLE_ARN }}
            role-session-name: GitHub_to_AWS_via_FederatedOIDC
            aws-region: ${{ env.AWS_REGION }}
        
        - name: Login to AWS ECR
          id: login-ecr
          uses: aws-actions/amazon-ecr-login@v2

        
        - name: Setup Docker Buildx
          run: docker buildx create --use
          
        - name: Build and Push Image
          id: build-push-image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            ECR_REPOSITORY: dataops-poc-deployment
            IMAGE_TAG: ${{ matrix.name }}-${{ matrix.version }}
            DOCKERFILE_PATH: ${{ matrix.dockerfile }}
            BUILD_CONTEXT: ${{ matrix.context }}
            PYTHON_VERSION: ${{ matrix.python_version }}
          run: |
            set -euo pipefail
            echo "Building and pushing: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
            docker buildx build \
              --file $DOCKERFILE_PATH \
              --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
              --platform linux/amd64 \
              --build-arg $PYTHON_VERSION \
              --push \
              $BUILD_CONTEXT
            echo "Image built and pushed successfully."
            echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> "$GITHUB_OUTPUT"