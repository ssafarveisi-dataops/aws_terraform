name: Model Infrastructure and Deployment

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "What do you want to run?"
        required: true
        type: choice
        options:
          - infra  # If you only want to apply or destroy resources
          - deploy # If you want to deploy (update) a service
          - full   # If you want to both apply resources and deploy a service
      action:
        description: "Action to perform (infra only)"
        required: false
        type: choice
        options:
          - apply
          - destroy
      model:
        description: "Model directory"
        required: true
        type: string

env:
  AWS_REGION: "eu-west-1"
  ECS_CLUSTER: "poc-deployment-cluster"
  ECR_REPOSITORY: "poc-deployment"

permissions:
  id-token: write
  contents: read

# Prevent concurrent runs per model
concurrency:
  group: poc-${{ inputs.model }}
  cancel-in-progress: false

jobs:
  # =====================
  # VALIDATION GUARDRAILS
  # =====================
  validate-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Validate workflow inputs
        shell: bash
        run: |
          set -euo pipefail

          MODE="${{ inputs.mode }}"
          ACTION="${{ inputs.action }}"

          if [[ "$MODE" == "infra" || "$MODE" == "full" ]]; then
            if [[ -z "$ACTION" ]]; then
              echo "ERROR: 'action' must be provided when mode is infra or full." >&2
              exit 1
            fi
          fi

          if [[ "$MODE" == "deploy" && -n "$ACTION" ]]; then
            echo "INFO: action input ignored for deploy-only mode."
          fi

  # ========================
  # JOB 1 ‚Äî MANAGE RESOURCES
  # ========================
  manage-resources:
    needs: validate-inputs
    if: ${{ inputs.mode == 'infra' || inputs.mode == 'full' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Extract configurations for other steps
        id: parse
        shell: bash
        run: |
          set -euo pipefail

          ACTION="${{ inputs.action }}"
          MODEL_DIR="${{ inputs.model }}"

          CONFIG_PATH="models_config/${MODEL_DIR}/config.yaml"
          if [[ ! -f "${CONFIG_PATH}" ]]; then
            echo "ERROR: Config not found at: ${CONFIG_PATH}" >&2
            exit 1
          fi

          IMAGE="$(yq -r '.app.container.image' "${CONFIG_PATH}")"
          S3_BUCKET="$(yq -r '.app.artifacts.s3_bucket' "${CONFIG_PATH}")"
          S3_PREFIX="$(yq -r '.app.artifacts.s3_prefix' "${CONFIG_PATH}")"
          APP_PORT="$(yq -r '.app.port_mapping.port' "${CONFIG_PATH}")"
          PRIORITY="$(yq -r '.routing.priority' "${CONFIG_PATH}")"

          validate_not_empty() {
            local name="$1"
            local value="$2"
            if [[ -z "$value" || "$value" == "null" ]]; then
              echo "ERROR: ${name} is missing or empty in YAML (${CONFIG_PATH})" >&2
              exit 1
            fi
          }

          validate_not_empty "app.container.image" "$IMAGE"
          validate_not_empty "app.artifacts.s3_bucket" "$S3_BUCKET"
          validate_not_empty "app.artifacts.s3_prefix" "$S3_PREFIX"
          validate_not_empty "app.port_mapping.port" "$APP_PORT"
          validate_not_empty "routing.priority" "$PRIORITY"

          if [[ "$S3_PREFIX" == /* || "$S3_PREFIX" == */ ]]; then
            echo "ERROR: app.artifacts.s3_prefix cannot start or end with '/': ${S3_PREFIX}" >&2
            exit 1
          fi

          {
            echo "action=${ACTION}"
            echo "config_path=${CONFIG_PATH}"
            echo "image=${IMAGE}"
            echo "s3_bucket=${S3_BUCKET}"
            echo "s3_prefix=${S3_PREFIX}"
            echo "app_port=${APP_PORT}"
            echo "priority=${PRIORITY}"
            echo "prefix=${MODEL_DIR}"
          } >> "$GITHUB_OUTPUT"

          echo "INFO: Successfully parsed configuration for model '${MODEL_DIR}'"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ env.AWS_REGION }}

      - name: Create resources
        if: steps.parse.outputs.action == 'apply'
        shell: bash
        env:
          VPC_ID: ${{ vars.VPC_ID }}
          CIDR_IPV4: ${{ vars.CIDR_IPV4 }}
          LISTENER_ARN: ${{ vars.LISTENER_ARN }}
          ECS_CLUSTER_ID: ${{ vars.ECS_CLUSTER_ID }}
          SUBNETS_CSV: ${{ vars.SUBNETS_CSV }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail

          PREFIX="${{ steps.parse.outputs.prefix }}"
          IMAGE="${{ steps.parse.outputs.image }}"
          S3_BUCKET="${{ steps.parse.outputs.s3_bucket }}"
          S3_PREFIX="${{ steps.parse.outputs.s3_prefix }}"
          PRIORITY="${{ steps.parse.outputs.priority }}"
          APP_PORT="${{ steps.parse.outputs.app_port }}"

          ./manage_resources.sh create \
            "${PREFIX}" \
            "${S3_BUCKET}" \
            "${S3_PREFIX}" \
            "${VPC_ID}" \
            "${APP_PORT}" \
            "${CIDR_IPV4}" \
            "${LISTENER_ARN}" \
            "${PRIORITY}" \
            "${ECS_CLUSTER_ID}" \
            "${SUBNETS_CSV}" \
            "${AWS_REGION}" \
            "${IMAGE}"

      - name: Destroy resources
        if: steps.parse.outputs.action == 'destroy'
        shell: bash
        env:
          VPC_ID: ${{ vars.VPC_ID }}
          LISTENER_ARN: ${{ vars.LISTENER_ARN }}
          ECS_CLUSTER_ID: ${{ vars.ECS_CLUSTER_ID }}
        run: |
          set -euo pipefail

          PREFIX="${{ steps.parse.outputs.prefix }}"
          PRIORITY="${{ steps.parse.outputs.priority }}"

          ./manage_resources.sh destroy \
            "${PREFIX}" \
            "${VPC_ID}" \
            "${LISTENER_ARN}" \
            "${PRIORITY}" \
            "${ECS_CLUSTER_ID}"
    
      # -----------------------
      # Slack: Create succeeded
      # -----------------------
      - name: Send Slack Notification (create success)
        if: ${{ success() && steps.parse.outputs.action == 'apply' }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID }}",
              "text": "‚úÖ üöÄ Resource creation succeeded: *${{ steps.parse.outputs.prefix }}*",
              "attachments": [
                {
                  "color": "2EB67D",
                  "fields": [
                    { "title": "Model", "value": "${{ steps.parse.outputs.prefix }}", "short": true },
                    { "title": "ALB prefix", "value": "${{ steps.parse.outputs.prefix }}", "short": true },
                    { "title": "S3", "value": "s3://${{ steps.parse.outputs.s3_bucket }}/${{ steps.parse.outputs.s3_prefix }}", "short": false },
                    { "title": "Run", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false }
                  ]
                }
              ]
            }

      # ------------------------
      # Slack: Destroy succeeded
      # ------------------------
      - name: Send Slack Notification (destroy success)
        if: ${{ success() && steps.parse.outputs.action == 'destroy' }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID }}",
              "text": "‚úÖ üßπ Resource destruction succeeded: *${{ steps.parse.outputs.prefix }}*",
              "attachments": [
                {
                  "color": "2EB67D",
                  "fields": [
                    { "title": "Model", "value": "${{ steps.parse.outputs.prefix }}", "short": true },
                    { "title": "Run", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false }
                  ]
                }
              ]
            }

      # ----------------------------------------
      # Slack: Action failed (create OR destroy)
      # ----------------------------------------
      - name: Send Slack Notification (failure)
        if: ${{ failure() && (steps.parse.outputs.action == 'apply' || steps.parse.outputs.action == 'destroy') }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID }}",
              "text": "‚ùå üî• Action in resource management failed: *${{ steps.parse.outputs.action }}* for *${{ steps.parse.outputs.prefix }}*",
              "attachments": [
                {
                  "color": "E01E5A",
                  "fields": [
                    { "title": "Action", "value": "${{ steps.parse.outputs.action }}", "short": true },
                    { "title": "Model", "value": "${{ steps.parse.outputs.prefix }}", "short": true },
                    { "title": "Run", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false }
                  ]
                }
              ]
            }
  # ===================
  # JOB 2 ‚Äî DEPLOY TASK
  # ===================
  deploy-task:
    name: Deploy Task manifest file
    needs: [validate-inputs, manage-resources]
    if: >
        always() &&
        (
            inputs.mode == 'deploy' ||
            inputs.mode == 'full'
        ) &&
        (
            needs.manage-resources.result == 'success' ||
            needs.manage-resources.result == 'skipped'
        )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v5
        with:
          ref: main

      - name: Extract configurations for other steps
        id: parse
        shell: bash
        run: |
          set -euo pipefail

          MODEL_DIR="${{ inputs.model }}"

          MODEL_PATH="models/${MODEL_DIR}"
          CONFIG_PATH="models_config/${MODEL_DIR}/config.yaml"
          DOCKERFILE_PATH="${MODEL_PATH}/Dockerfile"
          PYTHON_VERSION_FILE="${MODEL_PATH}/.python-version"
          PYPROJECT="${MODEL_PATH}/pyproject.toml"
          UV_LOCK_FILE="${MODEL_PATH}/uv.lock"
          SRC_FOLDER="${MODEL_PATH}/src"

          [[ -d "${MODEL_PATH}" ]] || { echo "ERROR: ${MODEL_PATH} does not exist" >&2; exit 1; }
          [[ -f "${DOCKERFILE_PATH}" ]] || { echo "ERROR: Missing Dockerfile at ${DOCKERFILE_PATH}" >&2; exit 1; }
          [[ -f "${PYTHON_VERSION_FILE}" ]] || { echo "ERROR: Missing .python-version at ${PYTHON_VERSION_FILE}" >&2; exit 1; }
          [[ -f "${CONFIG_PATH}" ]] || { echo "ERROR: Missing config.yaml at ${CONFIG_PATH}" >&2; exit 1; }
          [[ -f "${PYPROJECT}" ]] || { echo "ERROR: Missing pyproject.toml at ${PYPROJECT}" >&2; exit 1; }
          [[ -f "${UV_LOCK_FILE}" ]] || { echo "ERROR: Missing uv lock file at ${UV_LOCK_FILE}" >&2; exit 1; }
          [[ -d "${SRC_FOLDER}" ]] || { echo "ERROR: Missing src folder at ${SRC_FOLDER}" >&2; exit 1; }

          PYTHON_VERSION="$(head -n 1 "$PYTHON_VERSION_FILE" | tr -d '[:space:]')"

          validate_not_empty() {
            local name="$1"
            local value="$2"
            if [[ -z "$value" || "$value" == "null" ]]; then
              echo "ERROR: '${name}' is missing or empty." >&2
              exit 1
            fi
          }

          validate_not_empty ".python-version" "$PYTHON_VERSION"

          {
            echo "model_dir=${MODEL_DIR}"
            echo "model_path=${MODEL_PATH}"
            echo "dockerfile_path=${DOCKERFILE_PATH}"
            echo "python_version=${PYTHON_VERSION}"
            echo "config_path=${CONFIG_PATH}"
          } >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to AWS ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup Docker Buildx
        shell: bash
        run: |
          set -euo pipefail
          docker buildx create --use

      - name: Build and Push Image
        id: build-push-image
        shell: bash
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: "${{ steps.parse.outputs.model_dir }}-latest"
          DOCKERFILE_PATH: ${{ steps.parse.outputs.dockerfile_path }}
          BUILD_CONTEXT: ${{ steps.parse.outputs.model_path }}
          PYTHON_VERSION: ${{ steps.parse.outputs.python_version }}
        run: |
          set -euo pipefail
          echo "INFO: Building and pushing: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          docker buildx build \
            --file "$DOCKERFILE_PATH" \
            --tag "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            --platform linux/amd64 \
            --build-arg PYTHON_VERSION="$PYTHON_VERSION" \
            --push \
            "$BUILD_CONTEXT"

          echo "INFO: Image pushed successfully."
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: Render ECS task definition
        id: render-taskdef
        shell: bash
        env:
          FAMILY: ${{ steps.parse.outputs.model_dir }}-poc-deployment-task
          TASK_ROLE_ARN: arn:aws:iam::463470983643:role/${{ steps.parse.outputs.model_dir }}-poc-deployment-task-role
          EXEC_ROLE_ARN: arn:aws:iam::463470983643:role/${{ steps.parse.outputs.model_dir }}-poc-deployment-task-execution-role
          IMAGE: ${{ steps.build-push-image.outputs.image }}
          LOG_GROUP: poc-deployment-${{ steps.parse.outputs.model_dir }}-logs
        run: |
          ./render-task-def.sh ${{ steps.parse.outputs.config_path }} taskdef.json taskdef.rendered.json

      - name: Deploy Amazon ECS Task Definition
        id: deploy-ecs-task
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: taskdef.rendered.json
          service: ${{ steps.parse.outputs.model_dir }}-poc-deployment-service
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          wait-for-minutes: 20

      - name: Send Slack Notification (success)
        if: ${{ success() && steps.deploy-ecs-task.outcome == 'success' }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID }}",
              "text": "‚úÖ üöÄ ECS deployment successful: *${{ steps.parse.outputs.model_dir }}*",
              "attachments": [
                {
                  "color": "2EB67D",
                  "fields": [
                    { "title": "Cluster", "value": "${{ env.ECS_CLUSTER }}", "short": true },
                    { "title": "Service", "value": "${{ steps.parse.outputs.model_dir }}-poc-deployment-service", "short": true },
                    { "title": "Run", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false }
                  ]
                }
              ]
            }

      - name: Send Slack Notification (failure)
        if: ${{ always() && steps.deploy-ecs-task.outcome == 'failure' }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID }}",
              "text": "‚ùå ECS deployment failed: *${{ steps.parse.outputs.model_dir }}*",
              "attachments": [
                {
                  "color": "E01E5A",
                  "fields": [
                    { "title": "Cluster", "value": "${{ env.ECS_CLUSTER }}", "short": true },
                    { "title": "Service", "value": "${{ steps.parse.outputs.model_dir }}-poc-deployment-service", "short": true },
                    { "title": "Run", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false }
                  ]
                }
              ]
            }

      - name: Clean up Docker
        if: always()
        run: docker system prune --all --force